version: 2.1

# Use the Node.js orb to simplify installation and caching
orbs:
  node: circleci/node@5.1.0

jobs:
  check-and-test:
    docker:
      - image: cimg/node:22.12 # matches the Node version from our documentation
    steps:
      - checkout
      
      # 1. Install dependencies with caching automatically handled by the orb
      - node/install-packages:
          pkg-manager: npm

          # OVERRIDE: We use --legacy-peer-deps because react-scripts (v5.0.1) 
          # has a peer dependency conflict with TypeScript (v5.x). 
          # This flag allows the build to proceed despite the version mismatch.

          # WHY THIS IS SAFE: React Scripts 5's internal build tools (Webpack/Babel) 
          # are functionally compatible with TypeScript 5 syntax. The mismatch is 
          # purely a metadata restriction in react-scripts' package.json that was 
          # never updated. Using this flag bypasses the version check without 
          # compromising the stability of the build.
          override-ci-command: npm install --legacy-peer-deps

      # 2. Check Formatting (Prettier)
      - run:
          name: Check Formatting
          command: npm run format:check

      # 3. Static Type Checking (TypeScript)
      - run:
          name: TypeScript Type Check
          command: npm run type-check

      # 4. Run All Tests
      - run:
          name: Run Tests
          command: npm test

workflows:
  build-and-test:
    jobs:
      - check-and-test