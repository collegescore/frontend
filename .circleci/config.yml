version: 2.1

# Use the Node.js orb to simplify installation and caching
orbs:
  node: circleci/node@5.1.0

jobs:
  lint-and-type-check:
    docker:
      - image: cimg/node:22.12 # matches the Node version from our documentation
    steps:
      - checkout
      
      - node/install-packages:
          pkg-manager: npm

          # OVERRIDE: We use --legacy-peer-deps because react-scripts (v5.0.1) 
          # has a peer dependency conflict with TypeScript (v5.x). 
          # This flag allows the build to proceed despite the version mismatch.

          # WHY THIS IS SAFE: React Scripts 5's internal build tools (Webpack/Babel) 
          # are functionally compatible with TypeScript 5 syntax. The mismatch is 
          # purely a metadata restriction in react-scripts' package.json that was 
          # never updated. Using this flag bypasses the version check without 
          # compromising the stability of the build.
          override-ci-command: npm install --legacy-peer-deps

      # Check Formatting (Prettier)
      - run:
          name: Check Formatting
          command: npm run format:check

      # Static Type Checking (TypeScript)
      - run:
          name: TypeScript Type Check
          command: npm run type-check

  unit-tests:
    docker:
      - image: cimg/node:22.12
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          override-ci-command: npm install --legacy-peer-deps
      # run all unit tests
      - run:
          name: Run Jest Tests
          command: npm test

workflows:
  quality-gate:
    jobs:
      - lint-and-type-check
      - unit-tests:
          requires:
            - lint-and-type-check # Only run tests if types and formatting pass